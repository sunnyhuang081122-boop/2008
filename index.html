<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>äºŒæ—¥ç•«å®¤ï½œæ’å–®</title>

  <style>
    :root{
      --bg:#fdecef;
      --card:#ffffff;
      --ink:#1e1e1e;
      --muted:#8b8b8b;
      --line:#e9e6e7;
      --pink:#f5b6c6;
      --pink-2:#ffe1e8;
      --shadow: 0 12px 30px rgba(0,0,0,.06);
      --radius: 18px;
      --radius-2: 14px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    /* å¤–æ¡†ï¼šæ‰‹æ©Ÿå„ªå…ˆ */
    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 26px 18px 44px;
    }

    /* åªç•™å¤§æ¨™é¡Œï¼ˆåŒ¡å¤–ä¸å‡ºç¾å…¶ä»–å­—ï¼‰ */
    .title{
      font-size: 44px;
      letter-spacing: .06em;
      margin: 6px 0 18px;
      font-weight: 800;
      line-height: 1.05;
    }

    /* å¤§å¡ç‰‡ï¼ˆå…§å®¹éƒ½åœ¨å¡ç‰‡å…§ï¼‰ */
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 16px;
      margin-bottom: 16px;
    }

    .card h2{
      margin: 0 0 12px;
      font-size: 18px;
      letter-spacing: .06em;
      font-weight: 800;
    }

    .field{
      width: 100%;
      border: 1px solid #d8d8d8;
      border-radius: 10px;
      padding: 12px 12px;
      font-size: 16px;
      outline: none;
      background: #fff;
    }
    .field:focus{
      border-color: #bfbfbf;
      box-shadow: 0 0 0 4px rgba(245,182,198,.35);
    }

    .row{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      align-items: center;
    }

    .btn{
      border: none;
      background: linear-gradient(180deg, var(--pink), #f2a8bb);
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: .08em;
      box-shadow: 0 10px 20px rgba(242,168,187,.35);
      cursor: pointer;
      min-width: 130px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    /* æ¸…å–® */
    #queueList{
      display:flex;
      flex-direction: column;
      gap: 12px;
    }

    .queue-item{
      position: relative;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: var(--radius-2);
      padding: 16px 16px;
      box-shadow: 0 10px 22px rgba(0,0,0,.05);
      display:flex;
      align-items:center;
      justify-content: space-between;
      overflow:hidden;
    }

    /* å·¦å´ç²‰è‰²è£é£¾æ¢ */
    .queue-item::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 10px;
      background: var(--pink);
      opacity: .85;
    }

    .left{
      display:flex;
      flex-direction: column;
      gap: 6px;
      padding-left: 8px;
    }

    .rank{
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .06em;
    }

    .name{
      font-size: 20px;
      font-weight: 900;
      letter-spacing: .06em;
    }

    /* å¾…å¯©æ ¸å°æ¡†ï¼ˆä¸æ˜¯æ‹¬è™Ÿï¼‰ */
    .badge{
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .06em;
      color: #b84a68;
      background: var(--pink-2);
      border: 1px solid rgba(245,182,198,.8);
      padding: 8px 12px;
      border-radius: 999px;
      white-space: nowrap;
      margin-left: 12px;
    }

    /* loading / æç¤º */
    .hint{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      letter-spacing: .04em;
    }

    /* å°è¢å¹•å¾®èª¿ */
    @media (max-width: 390px){
      .title{ font-size: 40px; }
      .name{ font-size: 19px; }
      .btn{ min-width: 120px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">äºŒæ—¥ç•«å®¤</div>

    <div class="card">
      <h2>åŠ å…¥æ’å–®</h2>
      <input id="nickname" class="field" placeholder="ä¾‹å¦‚ï¼šå°èŠ±" maxlength="30" />
      <div class="row">
        <button id="joinBtn" class="btn">åŠ å…¥æ’å–®</button>
      </div>
      <div id="joinHint" class="hint"></div>
    </div>

    <div class="card" id="queueSection">
      <h2>ç›®å‰æ’å–®é †åº</h2>
      <div id="queueList"></div>
      <div id="queueHint" class="hint"></div>
    </div>
  </div>

  <!-- âœ… JS æ”¾æœ€åº•ä¸‹é¿å…ç™½ç•«é¢ -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ğŸ” æ”¹æˆä½ è‡ªå·±çš„
    const SUPABASE_URL = "https://fwirtycqfyvsebnqmjux.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3aXJ0eWNxZnl2c2VibnFtanV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4Njc1MjIsImV4cCI6MjA4MzQ0MzUyMn0.Y_kOH4c2VPlWbOHCB9fza8oH4Rm56kYTKuIlVZtVbvU";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM
    const input = document.getElementById("nickname");
    const joinBtn = document.getElementById("joinBtn");
    const queueList = document.getElementById("queueList");
    const queueSection = document.getElementById("queueSection");
    const joinHint = document.getElementById("joinHint");
    const queueHint = document.getElementById("queueHint");

    function scrollToQueue(){
      queueSection.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function setJoinHint(msg){
      joinHint.textContent = msg || "";
    }
    function setQueueHint(msg){
      queueHint.textContent = msg || "";
    }

    // æ¸²æŸ“ï¼šapproved æœ‰é †ä½ï¼Œpending æœ€åº•ä¸‹å¸¶ badge
    function renderQueue(data){
      queueList.innerHTML = "";

      const approved = data.filter(d => d.status === "approved");
      const pending  = data.filter(d => d.status === "pending");

      if (approved.length === 0 && pending.length === 0){
        setQueueHint("ç›®å‰é‚„æ²’æœ‰æ’å–®ã€‚");
        return;
      }
      setQueueHint("");

      approved.forEach((item, idx) => {
        const card = document.createElement("div");
        card.className = "queue-item";
        card.innerHTML = `
          <div class="left">
            <div class="rank">ç¬¬ ${idx + 1} ä½</div>
            <div class="name">${escapeHtml(item.nickname)}</div>
          </div>
          <div></div>
        `;
        queueList.appendChild(card);
      });

      pending.forEach((item) => {
        const card = document.createElement("div");
        card.className = "queue-item";
        card.innerHTML = `
          <div class="left">
            <div class="name">${escapeHtml(item.nickname)}</div>
          </div>
          <div class="badge">å¾…å¯©æ ¸</div>
        `;
        queueList.appendChild(card);
      });
    }

    // ç°¡å–®é˜² XSS
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // è®€å–è³‡æ–™ï¼ˆåªæŠ“ pending + approvedï¼›done ç›´æ¥ä¸é¡¯ç¤ºï¼‰
    async function loadQueue(){
      const { data, error } = await supabase
        .from("queue")
        .select("id, nickname, status, created_at")
        .in("status", ["pending","approved"])
        .order("created_at", { ascending: true });

      if (error){
        console.error(error);
        setQueueHint("è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        return;
      }
      renderQueue(data || []);
    }

    // æ–°å¢æ’å–®ï¼šä¸€å¾‹ pendingï¼ˆéšŠä¼æœ€æœ«ï¼‰
    joinBtn.addEventListener("click", async () => {
      const nickname = input.value.trim();
      if (!nickname) return alert("è«‹è¼¸å…¥æš±ç¨±");

      joinBtn.disabled = true;
      setJoinHint("å·²é€å‡ºï¼Œè«‹ç¨å€™â€¦");

      const { error } = await supabase
        .from("queue")
        .insert([{ nickname, status: "pending" }]);

      joinBtn.disabled = false;

      if (error){
        console.error(error);
        setJoinHint("é€å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚");
        alert("é€å‡ºå¤±æ•—ï¼Œå¯èƒ½æ˜¯æ¬Šé™æˆ–ç¶²è·¯å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        return;
      }

      input.value = "";
      setJoinHint("å·²é€å‡ºï¼å¯©æ ¸ä¸­æœƒé¡¯ç¤ºåœ¨æœ€ä¸‹æ–¹ã€‚");
      await loadQueue();
      scrollToQueue();
    });

    // âœ… Realtimeï¼šæœ‰äººæ–°å¢ / å¯©æ ¸ / å®Œæˆï¼Œå‰å°è‡ªå‹•æ›´æ–°
    supabase
      .channel("queue-live")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "queue" },
        () => loadQueue()
      )
      .subscribe();

    // åˆå§‹è¼‰å…¥
    loadQueue();
  </script>
</body>
</html>
